# Kubernetes StatefulSet

## Python app

```shell
$ kubectl get po,sts,svc,pvc
NAME                                        READY   STATUS    RESTARTS      AGE
pod/app-python-0                            1/1     Running   0             7m29s
pod/app-python-1                            1/1     Running   0             2m14s
pod/app-python-2                            1/1     Running   0             2m1s
pod/vault-0                                 1/1     Running   5 (27h ago)   15d
pod/vault-agent-injector-5d85ff9d44-jvbtd   1/1     Running   5 (27h ago)   15d

NAME                          READY   AGE
statefulset.apps/app-python   3/3     7m29s
statefulset.apps/vault        1/1     15d

NAME                               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
service/app-python                 ClusterIP   10.109.178.224   <none>        8080/TCP            7m30s
service/kubernetes                 ClusterIP   10.96.0.1        <none>        443/TCP             20d
service/vault                      ClusterIP   10.106.56.66     <none>        8200/TCP,8201/TCP   15d
service/vault-agent-injector-svc   ClusterIP   10.109.46.235    <none>        443/TCP             15d
service/vault-internal             ClusterIP   None             <none>        8200/TCP,8201/TCP   15d

NAME                                        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/visits-app-python-0   Bound    pvc-0ee44809-9834-4d57-a8e1-f5d81c8ae9c0   10Mi       RWO            standard       7m29s
persistentvolumeclaim/visits-app-python-1   Bound    pvc-73f6a9fe-927a-4c8b-a323-39bb3b140dd4   10Mi       RWO            standard       2m14s
persistentvolumeclaim/visits-app-python-2   Bound    pvc-0e8d84d7-b4b8-45ff-8aec-8bc10a5af709   10Mi       RWO            standard       2m1s

$ kubectl exec pod/app-python-0 -- cat /app/visits/visits.txt
39

$ kubectl exec pod/app-python-1 -- cat /app/visits/visits.txt
38

$ kubectl exec pod/app-python-2 -- cat /app/visits/visits.txt
45
```

## Kotlin app

```shell
$ kubectl get po,sts,svc,pvc
NAME                                        READY   STATUS    RESTARTS        AGE
pod/app-kotlin-0                            1/1     Running   1 (5m16s ago)   6m18s
pod/app-kotlin-1                            1/1     Running   1 (5m16s ago)   6m17s
pod/app-kotlin-2                            1/1     Running   1 (5m8s ago)    6m17s
pod/vault-0                                 1/1     Running   6 (13h ago)     16d
pod/vault-agent-injector-5d85ff9d44-jvbtd   1/1     Running   6 (13h ago)     16d

NAME                          READY   AGE
statefulset.apps/app-kotlin   3/3     6m19s
statefulset.apps/vault        1/1     16d

NAME                               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
service/app-kotlin                 ClusterIP   10.111.160.180   <none>        8000/TCP            6m19s
service/kubernetes                 ClusterIP   10.96.0.1        <none>        443/TCP             21d
service/vault                      ClusterIP   10.106.56.66     <none>        8200/TCP,8201/TCP   16d
service/vault-agent-injector-svc   ClusterIP   10.109.46.235    <none>        443/TCP             16d
service/vault-internal             ClusterIP   None             <none>        8200/TCP,8201/TCP   16d

NAME                                        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/visits-app-kotlin-0   Bound    pvc-d5d52434-770e-4374-9777-5180497b2ae4   10Mi       RWO            standard       6m18s
persistentvolumeclaim/visits-app-kotlin-1   Bound    pvc-23cda442-ae07-489a-a143-20e3c3298d8a   10Mi       RWO            standard       6m18s
persistentvolumeclaim/visits-app-kotlin-2   Bound    pvc-9b9cddb9-0c7a-4676-aaa2-7c3b49a1cdec   10Mi       RWO            standard       6m18s

$ kubectl exec pod/app-kotlin-0 -- cat /app/visits/visits.txt
53

$ kubectl exec pod/app-kotlin-1 -- cat /app/visits/visits.txt
54

$ kubectl exec pod/app-kotlin-2 -- cat /app/visits/visits.txt
52
```

## Questions

1. Describe and explain differences:
   - The application writes visits into persistent volume, which is unique for each node. Every time a request is made, it
    is randomly directed to one of the replicas. It leads to desyncronization of values. Also, healthchecks are counted as visits.
2. Explain why ordering guarantees are unnecessary for your app:
   - The application runs independently of other replicas, so the ordering is not necessary. It is required in cases, when
    the application requires other instances to be initialized before initializing itself
    (it may be master-slave architecture or if it is crucial for ensuring replicated data consistency).
3. Implement a way to instruct the StatefulSet controller to launch or terminate all Pods in parallel:
   - It is done using `podManagementPolicy: Parallel`.
4. Explore Update Strategies:
   - __Rolling Update__: default strategy. It updates pods one by one or depending on `Max Unavailable` and `Max Surge` parameters.
    Old pods are replaced with new ones when they are ready. Slow, but without downtime.
   - __Recreate__: all the old pods are terminated and then the new ones are created. With downtime.
   - __Blue/Green__: There are 2 versions of a deployment. One (Green) is being updated and tested, while the other (Blue) serves clients at old version.
    When Green is deployed and tested, clients are being redirected to it (in case of issues, you can rollback to Blue version).
    Without downtime, but expensive, since it requires you to maintain 2 deployments. However, after update the old cluster can be killed.
   - __Canary__: 2 versions are deployed (old and new). Users are gradually moved to the new version, allows the new version to be
    tested with real users. If there are any issues, you can return traffic to the old version. Expensive and without downtime.
    Additionally, if the broken application is deployed, it will affect only few users before detecting.
